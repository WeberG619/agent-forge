name: CI

on:
  push:
    branches: ["main", "dev", "feature/**"]
  pull_request:
    branches: ["main"]

# Cancel in-flight runs for the same branch on new push
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ─────────────────────────────────────────────────────────────────────────
  # 1. Lint Python with ruff
  # ─────────────────────────────────────────────────────────────────────────
  lint-python:
    name: "Lint Python (ruff)"
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11"]
      fail-fast: false

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install ruff
        run: pip install ruff

      - name: Run ruff (lint)
        run: |
          ruff check . \
            --exclude ".git,__pycache__,node_modules" \
            --output-format=github

      - name: Run ruff (format check)
        run: |
          ruff format --check . \
            --exclude ".git,__pycache__,node_modules"

  # ─────────────────────────────────────────────────────────────────────────
  # 2. Validate JSON and YAML configs
  # ─────────────────────────────────────────────────────────────────────────
  validate-configs:
    name: "Validate JSON / YAML configs"
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Run validate_configs.py
        run: python tests/validate_configs.py

  # ─────────────────────────────────────────────────────────────────────────
  # 3. Validate agent definitions
  # ─────────────────────────────────────────────────────────────────────────
  validate-agents:
    name: "Validate agent definitions"
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Run validate_agents.py
        run: python tests/validate_agents.py

  # ─────────────────────────────────────────────────────────────────────────
  # 4. ShellCheck — lint shell scripts
  # ─────────────────────────────────────────────────────────────────────────
  shellcheck:
    name: "ShellCheck"
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install ShellCheck
        run: sudo apt-get install -y shellcheck

      - name: Lint install.sh and uninstall.sh
        run: |
          shellcheck \
            --severity=warning \
            --exclude=SC2034,SC2015 \
            install.sh uninstall.sh

      - name: Lint any other .sh files (if present)
        run: |
          # Find additional shell scripts outside the root, excluding hidden dirs
          mapfile -t scripts < <(
            find . \
              -not -path "./.git/*" \
              -not -path "./node_modules/*" \
              -name "*.sh" \
              ! -name "install.sh" \
              ! -name "uninstall.sh"
          )
          if [ ${#scripts[@]} -gt 0 ]; then
            shellcheck --severity=warning "${scripts[@]}"
          else
            echo "No additional shell scripts found."
          fi

  # ─────────────────────────────────────────────────────────────────────────
  # 5. Test install.sh in CI mode
  # ─────────────────────────────────────────────────────────────────────────
  test-install:
    name: "Test install.sh --ci"
    runs-on: ubuntu-latest
    needs: [shellcheck]  # Only run after shellcheck passes

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Set up Git identity (required by installer)
        run: |
          git config --global user.email "ci@github.com"
          git config --global user.name "CI Runner"

      - name: Run installer in CI mode
        run: |
          chmod +x install.sh
          bash install.sh --ci
        env:
          # Installer respects these env vars in CI mode
          CI_USER_NAME: "ci-runner"
          CI_TIMEZONE: "UTC"
          CI_INSTALL_DIR: "${{ runner.temp }}/cadre-ai-install"

      - name: Verify install directory was created
        run: |
          INSTALL_DIR="${RUNNER_TEMP}/cadre-ai-install"
          echo "Checking install directory: $INSTALL_DIR"
          test -d "$INSTALL_DIR" || { echo "ERROR: install dir not created"; exit 1; }
          echo "Install dir contents:"
          ls -la "$INSTALL_DIR"

      - name: Verify core files were installed
        run: |
          INSTALL_DIR="${RUNNER_TEMP}/cadre-ai-install"
          CLAUDE_DIR="$HOME/.claude"

          # Core framework
          test -d "$INSTALL_DIR/framework" || { echo "ERROR: framework dir missing"; exit 1; }

          # Agent definitions
          test -d "$CLAUDE_DIR/agents" || { echo "ERROR: agents dir missing"; exit 1; }
          AGENT_COUNT=$(ls "$CLAUDE_DIR/agents/"*.md 2>/dev/null | wc -l)
          echo "Installed $AGENT_COUNT .md agent files"
          test "$AGENT_COUNT" -ge 10 || { echo "ERROR: expected at least 10 agents, got $AGENT_COUNT"; exit 1; }

          # Commands
          test -d "$CLAUDE_DIR/commands" || { echo "ERROR: commands dir missing"; exit 1; }

          # CLAUDE.md generated
          test -f "$CLAUDE_DIR/CLAUDE.md" || { echo "ERROR: CLAUDE.md not generated"; exit 1; }

          echo "All core install checks passed."

      - name: Upload install artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: install-debug
          path: |
            ~/.claude/
            ${{ runner.temp }}/cadre-ai-install/

  # ─────────────────────────────────────────────────────────────────────────
  # 6. Test uninstall.sh after install
  # ─────────────────────────────────────────────────────────────────────────
  test-uninstall:
    name: "Test uninstall.sh --ci"
    runs-on: ubuntu-latest
    needs: [test-install]  # Must run after install test passes

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Set up Git identity
        run: |
          git config --global user.email "ci@github.com"
          git config --global user.name "CI Runner"

      - name: Install first (prerequisite for uninstall test)
        run: |
          chmod +x install.sh
          bash install.sh --ci
        env:
          CI_USER_NAME: "ci-runner"
          CI_TIMEZONE: "UTC"
          CI_INSTALL_DIR: "${{ runner.temp }}/cadre-ai-install"

      - name: Run uninstaller in CI mode
        run: |
          CADRE_DIR="${RUNNER_TEMP}/cadre-ai-install" bash uninstall.sh --ci

      - name: Verify install directory was removed
        run: |
          INSTALL_DIR="${RUNNER_TEMP}/cadre-ai-install"
          if [ -d "$INSTALL_DIR" ]; then
            echo "ERROR: install directory still exists after uninstall: $INSTALL_DIR"
            ls -la "$INSTALL_DIR"
            exit 1
          fi
          echo "Install directory successfully removed."

      - name: Verify agents were removed from ~/.claude
        run: |
          CLAUDE_DIR="$HOME/.claude"
          # Check that none of the known cadre agent files remain
          REMAINING=$(ls "$CLAUDE_DIR/agents/"*.md 2>/dev/null | wc -l || echo "0")
          echo "Remaining agent files in ~/.claude/agents: $REMAINING"
          # Uninstaller only removes cadre-specific agents; user agents are untouched.
          # In CI there are no user agents, so count should be 0.
          test "$REMAINING" -eq 0 || {
            echo "ERROR: expected 0 agent files after uninstall, got $REMAINING"
            ls "$CLAUDE_DIR/agents/"
            exit 1
          }
          echo "Uninstall verification passed."

  # ─────────────────────────────────────────────────────────────────────────
  # 7. Summary gate — all jobs must pass
  # ─────────────────────────────────────────────────────────────────────────
  ci-pass:
    name: "CI Pass"
    runs-on: ubuntu-latest
    needs:
      - lint-python
      - validate-configs
      - validate-agents
      - shellcheck
      - test-install
      - test-uninstall
    if: always()

    steps:
      - name: Check all jobs passed
        run: |
          results='${{ toJSON(needs) }}'
          echo "$results" | python3 -c "
          import json, sys
          needs = json.load(sys.stdin)
          failed = [job for job, data in needs.items() if data['result'] != 'success']
          if failed:
              print('FAILED jobs:', ', '.join(failed))
              sys.exit(1)
          print('All CI jobs passed.')
          "
